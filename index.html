<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Listing Generator</title>
    <meta name="description" content="Generate marketplace listings from photos">
    <meta name="theme-color" content="#3B82F6">
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIkFJIExpc3RpbmcgR2VuZXJhdG9yIiwKICAic2hvcnRfbmFtZSI6ICJMaXN0aW5nIEFJIiwKICAiZGVzY3JpcHRpb24iOiAiR2VuZXJhdGUgbWFya2V0cGxhY2UgbGlzdGluZ3MgZnJvbSBwaG90b3MiLAogICJzdGFydF91cmwiOiAiLyIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiI2ZmZmZmZiIsCiAgInRoZW1lX2NvbG9yIjogIiMzQjgyRjYiLAogICJpY29ucyI6IFsKICAgIHsKICAgICAgInNyYyI6ICJkYXRhOmltYWdlL3N2Zyt4bWwsJTNDc3ZnJTIwdmlld0JveCUzRCcwJTIwMCUyMDI0JTIwMjQnJTIweG1sbnMlM0QnaHR0cCUzQSUyRiUyRnd3dy53My5vcmclMkYyMDAwJTJGc3ZnJyUzRSUzQ3BhdGglMjBkJTNEJ201JTIwMTNoMTRsLTklMjA5JTIwOWwtOS05JTIwNC00aDJ2LTJoLTJ2LTFoLTJsLTQtNGgtMnYtMWgtMnYtMmw0LTRoMnYtMWgydjJoMmw0JTIwNGgydjFoMnYyaC0ydjJoLTJsLTQlMjA0aC0ydjFoLTJ2LTJoLTJsLTQtNGgtMnYtMWgtMnYyaC0yeiclMkYlM0UlM0MlMkZzdmclM0UiLAogICAgICAidHlwZSI6ICJpbWFnZS9zdmcreG1sIiwKICAgICAgInNpemVzIjogIjE5MngxOTIiCiAgICB9CiAgXQp9">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='m5 13h14l-9 9 9l-9-9 4-4h2v-2h-2v-1h-2l-4-4h-2v-1h-2v-2l4-4h2v-1h2v2h2l4 4h2v1h2v2h-2v2h-2l-4 4h-2v1h-2v-2h-2l-4-4h-2v-1h-2v2h-2z'/%3E%3C/svg%3E">
    
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #1a202c;
            line-height: 1.7;
            -webkit-font-smoothing: antialiased;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 1rem;
            min-height: 100vh;
        }
        
        .header {
            text-align: center;
            margin-bottom: 3rem;
            padding: 3rem 0 2rem;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .header h1 {
            font-size: 3rem;
            font-weight: 800;
            color: #ffffff;
            margin-bottom: 1rem;
            text-shadow: 0 4px 12px rgba(0,0,0,0.3);
            letter-spacing: -0.02em;
        }
        
        .header p {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1.2rem;
            font-weight: 400;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .settings-btn {
            position: fixed;
            top: 2rem;
            right: 2rem;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            width: 56px;
            height: 56px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            z-index: 100;
            color: white;
            transition: all 0.3s ease;
        }
        
        .settings-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
        }
        
        .alert {
            margin-bottom: 1rem;
            padding: 0.75rem;
            border-radius: 0.5rem;
            display: none;
        }
        
        .alert.success {
            background: rgba(220, 252, 231, 0.95);
            backdrop-filter: blur(10px);
            color: #166534;
            border: 1px solid rgba(187, 247, 208, 0.5);
            border-radius: 1rem;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.1);
        }
        
        .alert.error {
            background: rgba(254, 242, 242, 0.95);
            backdrop-filter: blur(10px);
            color: #dc2626;
            border: 1px solid rgba(254, 202, 202, 0.5);
            border-radius: 1rem;
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.1);
        }
        
        .settings-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 1.5rem;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            display: none;
        }
        
        .upload-area {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 2px dashed rgba(255, 255, 255, 0.4);
            border-radius: 1.5rem;
            padding: 3rem 2rem;
            text-align: center;
            margin-bottom: 1.5rem;
            transition: border-color 0.2s;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .upload-area:active {
            border-color: #3b82f6;
        }
        
        .upload-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto 1rem;
            color: #9ca3af;
        }
        
        .image-preview {
            max-width: 100%;
            max-height: 200px;
            object-fit: contain;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .generate-btn {
            width: 100%;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            border-radius: 1rem;
            padding: 1.25rem;
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
            letter-spacing: 0.02em;
        }
        
        .generate-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(16, 185, 129, 0.4);
        }
        
        .generate-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        
        .generate-btn:not(:disabled):active {
            background: #15803d;
        }
        
        .tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border-radius: 1rem;
            padding: 0.375rem;
            margin-bottom: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .tab {
            flex: 1;
            background: transparent;
            border: none;
            padding: 1rem;
            border-radius: 0.75rem;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.8);
            transition: all 0.3s ease;
            font-size: 0.95rem;
        }
        
        .tab.active {
            background: rgba(255, 255, 255, 0.9);
            color: #1a202c;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .listing-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 1.5rem;
            padding: 2rem;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
        }
        
        .listing-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .copy-btn {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            border: none;
            border-radius: 0.75rem;
            padding: 0.75rem 1rem;
            font-size: 0.9rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }
        
        .copy-btn:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(99, 102, 241, 0.4);
        }
        
        .copy-btn:disabled {
            opacity: 0.5;
        }
        
        .listing-content {
            width: 100%;
            min-height: 300px;
            padding: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 1rem;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            font-size: 0.95rem;
            line-height: 1.6;
            resize: vertical;
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(10px);
        }
        
        .input-group {
            margin-bottom: 1rem;
        }
        
        .input-group label {
            display: block;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: #374151;
        }
        
        .input-group input {
            width: 100%;
            padding: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 0.75rem;
            font-size: 1rem;
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(10px);
        }
        
        .help-text {
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }
        
        .save-btn {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            border: none;
            border-radius: 0.75rem;
            padding: 1rem 1.5rem;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
            transition: all 0.3s ease;
        }
        
        .save-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(59, 130, 246, 0.4);
        }
        
        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .camera-btn {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 60px;
            height: 60px;
            background: #3b82f6;
            border: none;
            border-radius: 50%;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
            z-index: 100;
        }
        
        @media (max-width: 640px) {
            .container {
                padding: 0.5rem;
            }
            
            .header h1 {
                font-size: 1.5rem;
            }
            
            .settings-btn {
                width: 44px;
                height: 44px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <button class="settings-btn" onclick="toggleSettings()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="3"></circle>
                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1 1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
            </svg>
        </button>
        
        <div class="header">
            <h1>üì± AI Listing Generator</h1>
            <p>Take photos, get instant marketplace listings</p>
        </div>
        
        <div id="success-alert" class="alert success"></div>
        <div id="error-alert" class="alert error"></div>
        
        <div id="settings-panel" class="settings-panel">
            <h3 style="margin-bottom: 1rem;">API Settings</h3>
            <div class="input-group">
                <label>Claude API Key</label>
                <input type="password" id="api-key" placeholder="API key pre-configured">
                <p class="help-text">‚úÖ API key is pre-configured and ready to use!</p>
            </div>
            <button class="save-btn" onclick="saveApiKey()">Update API Key</button>
        </div>
        
        <div class="upload-buttons" style="display: flex; gap: 0.5rem; margin-bottom: 1.5rem;">
            <button onclick="triggerCamera()" style="flex: 1; background: #3b82f6; color: white; border: none; border-radius: 0.75rem; padding: 1rem; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                    <circle cx="12" cy="13" r="4"></circle>
                </svg>
                Take Photo
            </button>
            <button onclick="triggerGallery()" style="flex: 1; background: #16a34a; color: white; border: none; border-radius: 0.75rem; padding: 1rem; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                    <circle cx="8.5" cy="8.5" r="1.5"></circle>
                    <polyline points="21,15 16,10 5,21"></polyline>
                </svg>
                Choose Photos
            </button>
        </div>
        
        <input type="file" id="camera-input" accept="image/*" capture="environment" style="display: none;" onchange="handleImageUpload(event)">
        <input type="file" id="gallery-input" accept="image/*" multiple style="display: none;" onchange="handleImageUpload(event)">
        
        <div id="image-preview-container" style="display: none; background: white; border-radius: 0.75rem; padding: 1rem; margin-bottom: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h3 style="margin: 0;">Selected Images (<span id="image-count">0</span>)</h3>
                <button onclick="clearImages()" style="background: #ef4444; color: white; border: none; border-radius: 0.375rem; padding: 0.5rem; font-size: 0.875rem;">Clear All</button>
            </div>
            <div id="image-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 0.5rem;">
                <!-- Images will be displayed here -->
            </div>
        </div>
        
        <button class="generate-btn" id="generate-btn" onclick="generateListings()" disabled>
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21.5 2l-2 2m-2 2l-7 7-2.5-2.5a1.5 1.5 0 0 0-2.121 0l-.879.879A1.5 1.5 0 0 0 5.5 13.5L8 16l7-7 2-2 2-2z"></path>
                <path d="m6 16 2 2 7-7"></path>
            </svg>
            Generate Listings
        </button>
        
        <div class="tabs">
            <button class="tab active" onclick="switchTab('ebay')">Detective</button>
            <button class="tab" onclick="switchTab('craigslist')">Enthusiast</button>
            <button class="tab" onclick="switchTab('facebook')">Technical</button>
        </div>
        
        <div class="listing-container">
            <div class="listing-header">
                <h3 id="platform-title">Professional Description</h3>
                <div style="display: flex; gap: 0.5rem;">
                    <button class="copy-btn" id="save-btn" onclick="saveCurrentItem()" disabled>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                            <polyline points="17,21 17,13 7,13 7,21"></polyline>
                            <polyline points="7,3 7,8 15,8"></polyline>
                        </svg>
                        Save
                    </button>
                    <button class="copy-btn" id="copy-btn" onclick="copyToClipboard()" disabled>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                        </svg>
                        Copy
                    </button>
                </div>
            </div>
            <textarea id="listing-content" class="listing-content" placeholder="Generated descriptions will appear here..."></textarea>
        </div>
        
        <div class="listing-container" style="margin-top: 1rem;">
            <div class="listing-header">
                <h3>üìÅ Saved Items</h3>
                <div style="display: flex; gap: 0.5rem;">
                    <button class="copy-btn" onclick="exportAllData()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="17,10 12,15 7,10"></polyline>
                            <line x1="12" y1="15" x2="12" y2="3"></line>
                        </svg>
                        Export
                    </button>
                    <button class="copy-btn" onclick="toggleSavedItems()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="6,9 12,15 18,9"></polyline>
                        </svg>
                        View
                    </button>
                </div>
            </div>
            <div id="saved-items-list" style="display: none; max-height: 300px; overflow-y: auto;">
                <!-- Saved items will be populated here -->
            </div>
        </div>
        
    </div>

    <script>
        let selectedImages = [];
        let currentPlatform = 'ebay';
        let listings = { ebay: '', craigslist: '', facebook: '' };
        let savedItems = JSON.parse(localStorage.getItem('savedItems') || '[]');
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Pre-fill with your API key (base64 encoded for security)
            const encodedKey = 'c2stYW50LWFwaTAzLVNjNHhFTVRmSFk1akl6VC03MlBKZ3Frd0tkQmlSbXFxbDNma2JETkhhb1JSNkQ2XzFKSzFrNDRhS3V2TnNJQ3o0NHJyZl82V3FRajRySnNPckw1UWZBLTdkVlhvQUFB';
            const defaultApiKey = atob(encodedKey).trim();
            const savedApiKey = localStorage.getItem('claude_api_key') || defaultApiKey;
            document.getElementById('api-key').value = savedApiKey;
            
            // Auto-save the default key if nothing is saved
            if (!localStorage.getItem('claude_api_key')) {
                localStorage.setItem('claude_api_key', defaultApiKey);
            }
            
            // Register service worker for PWA
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('data:text/javascript,// PWA Service Worker');
            }
        });
        
        function toggleSettings() {
            const panel = document.getElementById('settings-panel');
            panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
        }
        
        function saveApiKey() {
            const apiKey = document.getElementById('api-key').value;
            localStorage.setItem('claude_api_key', apiKey);
            toggleSettings();
            showSuccess('API key saved!');
        }
        
        function triggerCamera() {
            document.getElementById('camera-input').click();
        }
        
        function triggerGallery() {
            document.getElementById('gallery-input').click();
        }
        
        function handleImageUpload(event) {
            const files = Array.from(event.target.files);
            if (!files.length) return;
            
            // Add new images to selected images array
            files.forEach(file => {
                if (file.size > 2 * 1024 * 1024) {
                    showSuccess(`Compressing ${file.name}...`);
                }
                selectedImages.push(file);
            });
            
            updateImagePreview();
            document.getElementById('generate-btn').disabled = false;
            
            // Clear the input for next selection
            event.target.value = '';
        }
        
        function updateImagePreview() {
            const container = document.getElementById('image-preview-container');
            const grid = document.getElementById('image-grid');
            const count = document.getElementById('image-count');
            
            count.textContent = selectedImages.length;
            
            if (selectedImages.length === 0) {
                container.style.display = 'none';
                return;
            }
            
            container.style.display = 'block';
            
            // Clear existing previews
            grid.innerHTML = '';
            
            selectedImages.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imageDiv = document.createElement('div');
                    imageDiv.style.cssText = 'position: relative; border-radius: 0.5rem; overflow: hidden;';
                    
                    imageDiv.innerHTML = `
                        <img src="${e.target.result}" style="width: 100%; height: 100px; object-fit: cover;">
                        <button onclick="removeImage(${index})" style="position: absolute; top: 2px; right: 2px; background: rgba(239, 68, 68, 0.9); color: white; border: none; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; cursor: pointer;">√ó</button>
                    `;
                    
                    grid.appendChild(imageDiv);
                };
                reader.readAsDataURL(file);
            });
        }
        
        function removeImage(index) {
            selectedImages.splice(index, 1);
            updateImagePreview();
            
            if (selectedImages.length === 0) {
                document.getElementById('generate-btn').disabled = true;
            }
        }
        
        function clearImages() {
            selectedImages = [];
            updateImagePreview();
            document.getElementById('generate-btn').disabled = true;
        }
        
        function switchTab(platform) {
            currentPlatform = platform;
            
            // Update tab styles
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            
            // Update content
            const titles = {
                ebay: 'Detective-Level Analysis',
                craigslist: 'Enthusiast Description', 
                facebook: 'Technical Specification'
            };
            document.getElementById('platform-title').textContent = titles[platform];
            document.getElementById('listing-content').value = listings[platform];
            
            // Update copy button state
            document.getElementById('copy-btn').disabled = !listings[platform];
        }
        
        async function generateListings() {
            if (selectedImages.length === 0) {
                showError('Please select at least one image first');
                return;
            }
            
            const apiKey = localStorage.getItem('claude_api_key');
            if (!apiKey) {
                showError('Please set your Claude API key in settings');
                toggleSettings();
                return;
            }
            
            const btn = document.getElementById('generate-btn');
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner"></div> Analyzing Image...';
            
            try {
                console.log('Processing', selectedImages.length, 'images');
                
                // Process all images
                const imagePromises = selectedImages.map(async (image, index) => {
                    console.log(`Image ${index + 1} original size:`, image.size, 'bytes');
                    const base64 = await convertImageToBase64(image);
                    console.log(`Image ${index + 1} compressed base64 size:`, base64.length, 'characters');
                    return {
                        type: 'image',
                        source: {
                            type: 'base64',
                            media_type: image.type,
                            data: base64
                        }
                    };
                });
                
                const imageContent = await Promise.all(imagePromises);
                
                const imageCount = selectedImages.length;
                const prompt = `Please conduct a thorough forensic analysis of ${imageCount > 1 ? 'these ' + imageCount + ' images' : 'this image'} and provide comprehensive product descriptions. ${imageCount > 1 ? 'Examine all images systematically for complete understanding - different angles, close-ups, labels, and components.' : ''} 

INVESTIGATION CHECKLIST - Look carefully for:
üîç BRAND IDENTIFICATION: Logos, brand names, manufacturer marks, emblems, wordmarks
üîç MODEL/PART NUMBERS: Serial numbers, model codes, part numbers, SKUs, barcodes
üîç TEXT & LABELS: Any visible text, stickers, labels, engravings, printed information
üîç MATERIALS & CONSTRUCTION: Metal types, plastic grades, fabric composition, build quality
üîç DESIGN DETAILS: Unique features, patterns, textures, color variations, finishing
üîç CONDITION FORENSICS: Wear patterns, scratches, dents, fading, aging signs
üîç SIZE INDICATORS: Relative size clues, scale references, dimensional hints
üîç FUNCTIONAL ELEMENTS: Buttons, switches, ports, connectors, moving parts
üîç PACKAGING/ACCESSORIES: Original boxes, manuals, cables, extra components

**FORMAT 1 - DETECTIVE-LEVEL DETAILED DESCRIPTION:**
Item Classification: [Specific item type and category]
Brand Discovery: [Any logos, brand marks, or manufacturer indicators found - describe location and appearance]
Model Intelligence: [Model numbers, part codes, or identifying text visible]
Construction Analysis: [Materials, build quality, manufacturing details]
Design Characteristics: [Unique features, styling elements, color schemes, patterns]
Dimensional Assessment: [Size estimates based on visual cues and proportions]
Condition Investigation: [Detailed wear analysis, age indicators, damage assessment]
Component Inventory: [Complete list of all visible parts, accessories, included items]
Text/Label Findings: [All readable text, labels, stickers, engravings transcribed]
Authentication Markers: [Any authenticity indicators, holograms, or verification marks]

**FORMAT 2 - ENTHUSIAST DESCRIPTION:**
What I'm Selling: [Conversational but thorough item identification]
Brand Story: [Brand background if identifiable, what makes this special]
The Details That Matter: 
- [Specific feature/detail with explanation]
- [Build quality or material highlight]
- [Condition specifics with honest assessment]
- [Functionality notes based on visual inspection]
- [Any collector/enthusiast value points]
Complete Package: [Everything included based on photos]
Condition Reality Check: [Honest condition notes, what to expect]
Why This One's Good: [Selling points based on visual evidence]

**FORMAT 3 - TECHNICAL SPECIFICATION SHEET:**
Product Designation: [Official or inferred product name]
Manufacturer Intelligence: [Brand identification and background]
Technical Specifications:
‚úì [Construction material and quality grade]
‚úì [Design generation or version if determinable]
‚úì [Key technical features visible]
‚úì [Compatibility or interface details]
‚úì [Performance indicators from visual inspection]
Physical Characteristics: [Exact visual measurements, weight estimation, form factor]
Condition Grade: [Professional condition assessment with specific criteria]
Completeness Analysis: [Inventory against standard product configuration]
Market Positioning: [Product tier/category based on visible quality indicators]
Documentation: [Any manuals, labels, or documentation visible]
Provenance Indicators: [Any clues about product history, usage, or origin]

CRITICAL: Examine every pixel. Read every visible character. Identify every logo. Note every detail. Provide comprehensive analysis worthy of a professional appraiser or forensic investigator. The more specific details you can extract, the better!`;

                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': apiKey,
                        'anthropic-version': '2023-06-01'
                    },
                    body: JSON.stringify({
                        model: 'claude-3-sonnet-20240229',
                        max_tokens: 3000,
                        messages: [{
                            role: 'user',
                            content: imageContent.concat([{
                                type: 'text',
                                text: prompt
                            }])
                        }]
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || `HTTP ${response.status}`);
                }

                const data = await response.json();
                const content = data.content[0].text;
                
                // Debug: log the raw response  
                console.log('Claude response:', content);
                console.log('API Key used:', apiKey.substring(0, 20) + '...');
                
                // Parse the new format sections
                const format1Match = content.match(/\*\*FORMAT 1[^:]*:\*\*(.*?)(?=\*\*FORMAT 2|$)/s);
                const format2Match = content.match(/\*\*FORMAT 2[^:]*:\*\*(.*?)(?=\*\*FORMAT 3|$)/s);
                const format3Match = content.match(/\*\*FORMAT 3[^:]*:\*\*(.*?)$/s);
                
                listings = {
                    ebay: format1Match ? format1Match[1].trim() : (content.includes('FORMAT 1') ? content : 'Detective analysis not found'),
                    craigslist: format2Match ? format2Match[1].trim() : (content.includes('FORMAT 2') ? content : 'Enthusiast description not found'),
                    facebook: format3Match ? format3Match[1].trim() : (content.includes('FORMAT 3') ? content : 'Technical specification not found')
                };
                
                // Update current view
                document.getElementById('listing-content').value = listings[currentPlatform];
                document.getElementById('copy-btn').disabled = false;
                document.getElementById('save-btn').disabled = false;
                
                showSuccess('Descriptions generated! üéâ');
                
            } catch (error) {
                showError('Error: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = `
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21.5 2l-2 2m-2 2l-7 7-2.5-2.5a1.5 1.5 0 0 0-2.121 0l-.879.879A1.5 1.5 0 0 0 5.5 13.5L8 16l7-7 2-2 2-2z"></path>
                        <path d="m6 16 2 2 7-7"></path>
                    </svg>
                    Generate Listings
                `;
            }
        }
        
        async function copyToClipboard() {
            const content = document.getElementById('listing-content').value;
            try {
                await navigator.clipboard.writeText(content);
                showSuccess('Copied to clipboard! üìã');
            } catch (err) {
                showError('Failed to copy');
            }
        }
        
        function convertImageToBase64(file) {
            return new Promise((resolve, reject) => {
                // First compress the image if it's too large
                compressImage(file, 1024, 1024, 0.8).then(compressedFile => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result.split(',')[1]);
                    reader.onerror = reject;
                    reader.readAsDataURL(compressedFile);
                }).catch(reject);
            });
        }
        
        function compressImage(file, maxWidth, maxHeight, quality) {
            return new Promise((resolve) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = function() {
                    // Calculate new dimensions
                    let { width, height } = img;
                    
                    if (width > height) {
                        if (width > maxWidth) {
                            height = (height * maxWidth) / width;
                            width = maxWidth;
                        }
                    } else {
                        if (height > maxHeight) {
                            width = (width * maxHeight) / height;
                            height = maxHeight;
                        }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    // Draw and compress
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    canvas.toBlob((blob) => {
                        const compressedFile = new File([blob], file.name, {
                            type: 'image/jpeg',
                            lastModified: Date.now()
                        });
                        resolve(compressedFile);
                    }, 'image/jpeg', quality);
                };
                
                img.src = URL.createObjectURL(file);
            });
        }
        
        function showSuccess(message) {
            const alert = document.getElementById('success-alert');
            alert.textContent = message;
            alert.style.display = 'block';
            setTimeout(() => alert.style.display = 'none', 3000);
        }
        
        function showError(message) {
            const alert = document.getElementById('error-alert');
            alert.textContent = message;
            alert.style.display = 'block';
            setTimeout(() => alert.style.display = 'none', 5000);
        }
        
        // Handle textarea updates
        document.getElementById('listing-content').addEventListener('input', function(e) {
            listings[currentPlatform] = e.target.value;
        });
        
        // Save current item functionality
        function saveCurrentItem() {
            if (selectedImages.length === 0 || !listings.ebay) {
                showError('Please generate descriptions first');
                return;
            }
            
            const itemName = prompt('Enter a name for this item:');
            if (!itemName) return;
            
            // Convert all images to base64
            const imagePromises = selectedImages.map(image => {
                return new Promise(resolve => {
                    const reader = new FileReader();
                    reader.onload = e => resolve(e.target.result);
                    reader.readAsDataURL(image);
                });
            });
            
            Promise.all(imagePromises).then(imageDataArray => {
                const savedItem = {
                    id: Date.now(),
                    name: itemName,
                    images: imageDataArray,
                    descriptions: {...listings},
                    date: new Date().toLocaleDateString()
                };
                
                savedItems.unshift(savedItem);
                localStorage.setItem('savedItems', JSON.stringify(savedItems));
                updateSavedItemsList();
                showSuccess('Item saved! üíæ');
            });
        }
        
        // Toggle saved items visibility
        function toggleSavedItems() {
            const list = document.getElementById('saved-items-list');
            if (list.style.display === 'none') {
                list.style.display = 'block';
                updateSavedItemsList();
            } else {
                list.style.display = 'none';
            }
        }
        
        // Update saved items list
        function updateSavedItemsList() {
            const container = document.getElementById('saved-items-list');
            if (savedItems.length === 0) {
                container.innerHTML = '<p style="padding: 1rem; color: #6b7280;">No saved items yet</p>';
                return;
            }
            
            container.innerHTML = savedItems.map(item => {
                // Handle both old single image format and new multiple images format
                const displayImage = item.images ? item.images[0] : item.image;
                const imageCount = item.images ? item.images.length : 1;
                const imageText = imageCount > 1 ? `${imageCount} photos` : '1 photo';
                
                return `
                    <div style="border-bottom: 1px solid #e5e7eb; padding: 1rem; display: flex; align-items: center; gap: 1rem;">
                        <div style="position: relative;">
                            <img src="${displayImage}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 0.5rem;">
                            ${imageCount > 1 ? `<span style="position: absolute; bottom: 2px; right: 2px; background: rgba(0,0,0,0.7); color: white; font-size: 0.7rem; padding: 2px 4px; border-radius: 2px;">${imageCount}</span>` : ''}
                        </div>
                        <div style="flex: 1;">
                            <h4 style="margin: 0; font-size: 0.9rem;">${item.name}</h4>
                            <p style="margin: 0; color: #6b7280; font-size: 0.8rem;">${imageText} ‚Ä¢ ${item.date}</p>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button onclick="loadSavedItem(${item.id})" style="background: #3b82f6; color: white; border: none; padding: 0.5rem; border-radius: 0.25rem; font-size: 0.8rem;">Load</button>
                            <button onclick="deleteSavedItem(${item.id})" style="background: #ef4444; color: white; border: none; padding: 0.5rem; border-radius: 0.25rem; font-size: 0.8rem;">Delete</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Load saved item
        function loadSavedItem(id) {
            const item = savedItems.find(item => item.id === id);
            if (!item) return;
            
            // Handle both old single image format and new multiple images format
            const imagesToLoad = item.images || [item.image];
            
            // Convert base64 images back to file objects
            const filePromises = imagesToLoad.map((imageData, index) => {
                return fetch(imageData)
                    .then(res => res.blob())
                    .then(blob => new File([blob], `saved-image-${index}.jpg`, { type: 'image/jpeg' }));
            });
            
            Promise.all(filePromises).then(files => {
                selectedImages = files;
                updateImagePreview();
            });
            
            // Load descriptions
            listings = {...item.descriptions};
            document.getElementById('listing-content').value = listings[currentPlatform];
            document.getElementById('copy-btn').disabled = false;
            document.getElementById('save-btn').disabled = false;
            document.getElementById('generate-btn').disabled = false;
            
            showSuccess(`Loaded: ${item.name}`);
        }
        
        // Delete saved item
        function deleteSavedItem(id) {
            if (!confirm('Delete this saved item?')) return;
            
            savedItems = savedItems.filter(item => item.id !== id);
            localStorage.setItem('savedItems', JSON.stringify(savedItems));
            updateSavedItemsList();
            showSuccess('Item deleted');
        }
        
        // Export all saved data
        function exportAllData() {
            if (savedItems.length === 0) {
                showError('No saved items to export');
                return;
            }
            
            const exportData = {
                version: '1.0',
                exportDate: new Date().toISOString(),
                source: 'AI Listing Generator',
                itemCount: savedItems.length,
                items: savedItems
            };
            
            const jsonData = JSON.stringify(exportData, null, 2);
            const blob = new Blob([jsonData], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `listing-generator-export-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showSuccess(`Exported ${savedItems.length} items! Use this file in AI Market Intelligence.`);
        }
    </script>
</body>
</html>
